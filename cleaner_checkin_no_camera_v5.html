<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>æ¸…æ½”äººå“¡ç°½åˆ°/ç°½é€€ï¼ˆç„¡ç›¸æ©Ÿç‰ˆ v5ï¼‰</title>
<style>
  :root{--bg:#f8fafc;--fg:#0f172a;--muted:#64748b;--card:#ffffff;--br:#e2e8f0;--pri:#111827;--pri-ink:#ffffff;--ok:#065f46;--ok-bg:#ecfdf5;--danger:#9f1239;--danger-bg:#fff1f2;}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","Microsoft JhengHei","Apple Color Emoji","Segoe UI Emoji",sans-serif}
  header{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--br);}
  .container{max-width:1000px;margin:0 auto;padding:12px 16px}
  h1{font-size:20px;margin:0 8px}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .grow{flex:1 1 520px}
  .side{flex:1 1 320px;max-width:420px}
  .card{background:var(--card);border:1px solid var(--br);border-radius:16px;box-shadow:0 1px 2px rgba(15,23,42,.06);padding:16px}
  .title{display:flex;align-items:center;gap:8px;font-weight:600}
  .muted{color:var(--muted)}
  button,.btn{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--br);border-radius:10px;padding:8px 10px;background:#fff;cursor:pointer}
  button:hover{background:#f1f5f9}
  .btn-primary{background:var(--pri);color:var(--pri-ink);border-color:#0b1220}
  .btn-primary:hover{background:#0b1324}
  .btn-danger{background:var(--danger-bg);color:var(--danger);border-color:#fecdd3}
  .btn-ok{background:var(--ok-bg);color:var(--ok);border-color:#86efac}
  input,select,textarea{border:1px solid var(--br);border-radius:10px;padding:8px 10px;font-size:14px;background:#fff}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:6px 8px;border-bottom:1px solid var(--br);text-align:left}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #c7d2fe;background:#eef2ff;color:#3730a3;font-size:12px}
  .list{border:1px solid var(--br);border-radius:12px;overflow:hidden;background:#fff}
  .list .item{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-top:1px solid var(--br)}
  .list .item:first-child{border-top:0}
  .w-100{width:100%}
  .mt-4{margin-top:16px}.mt-2{margin-top:8px}.mt-6{margin-top:24px}.mt-1{margin-top:4px}.mb-0{margin-bottom:0}
  .table-wrap{overflow:auto}
  @media print{
    header,.no-print{display:none!important}
    body{background:#fff}
    .card{border:0;box-shadow:none;padding:0}
    .container{max-width:none}
    .page-break{break-inside:avoid;page-break-inside:avoid}
  }
</style>
</head>
<body>
<header>
  <div class="container" style="display:flex;align-items:center;gap:8px;">
    <span>ğŸ§¹</span><h1>æ¸…æ½”äººå“¡ç°½åˆ° / ç°½é€€ï¼ˆç„¡ç›¸æ©Ÿç‰ˆ v5ï¼‰</h1>
    <div style="margin-left:auto;display:flex;align-items:center;gap:8px;" class="no-print">
      <span class="muted">æœˆä»½</span>
      <input id="monthPicker" type="month">
      <select id="filterStaff" title="ç¯©é¸äººå“¡"></select>
      <button id="btnExport" class="btn">â¬‡ï¸ åŒ¯å‡ºCSV</button>
      <button id="btnPrint" class="btn">ğŸ–¨ï¸ åˆ—å°ç°½åˆ°ç°¿</button>
    </div>
  </div>
</header>

<div class="container">
  <div class="row">
    <section class="grow">
      <div class="card">
        <div class="title">ğŸ”‘ ç®¡ç†å“¡ç™»å…¥</div>
        <div class="mt-2 no-print">
          <div id="adminStatus" class="muted">æœªç™»å…¥</div>
          <div class="mt-2" id="adminLoginBox">
            <input id="adminCodeInput" placeholder="è¼¸å…¥ç®¡ç†å“¡ä»£ç¢¼ï¼Œå¦‚ A001" style="width:200px">
            <button id="btnAdminLogin" class="btn">ç™»å…¥</button>
          </div>
          <div class="mt-2" id="adminAuthedBox" style="display:none">
            <span id="adminAuthedPill" class="pill"></span>
            <button id="btnAdminLogout" class="btn">ç™»å‡º</button>
          </div>
        </div>
      </div>

      <div class="card mt-4">
        <div class="title">ğŸ·ï¸ æŒ‡å®šäººå“¡ï¼ˆç”±å¤–éƒ¨ QR App é–‹å•Ÿï¼‰</div>
        <div class="mt-2">
          <div class="muted">å·²é¸äººå“¡</div>
          <div id="pickedStaff" style="font-weight:600;min-height:28px;margin-top:4px">â€”</div>
          <div class="mt-2" style="display:flex;gap:8px;align-items:center;">
            <input id="manualStaff" placeholder="ä¹Ÿå¯æ‰‹å‹•è¼¸å…¥ä»£è™Ÿï¼ˆå¦‚ C004ï¼‰" style="width:240px">
            <button id="btnUseManual" class="btn">é¸æ“‡</button>
          </div>
          <div class="mt-2 grid-3">
            <button data-shift="AM" class="btn" id="btnAM">ä¸Šåˆ</button>
            <button data-shift="PM" class="btn" id="btnPM">ä¸‹åˆ</button>
            <button data-shift="OT" class="btn" id="btnOT">åŠ ç­</button>
          </div>
          <div class="mt-2 grid-2">
            <button data-action="IN"  class="btn btn-ok" id="btnIN">ç°½åˆ°</button>
            <button data-action="OUT" class="btn btn-danger" id="btnOUT">ç°½é€€</button>
          </div>
          <input id="note" class="mt-2 w-100" placeholder="å‚™è¨»ï¼ˆé¸å¡«ï¼‰">
          <button id="btnSave" class="mt-2 w-100 btn-primary">âœ… å„²å­˜ç´€éŒ„</button>
          <button id="btnUndo" class="mt-2 w-100 btn-danger">ğŸ—‘ï¸ åˆªé™¤æœ€è¿‘ä¸€ç­†</button>
        </div>
      </div>

      <div class="card mt-4">
        <div class="title">â±ï¸ ç•¶æœˆç´€éŒ„</div>
        <div class="table-wrap mt-2">
          <table id="tblMonth">
            <thead>
              <tr>
                <th>æ—¥æœŸ</th><th>æ™‚é–“</th><th>å“¡å·¥</th><th>ç­åˆ¥</th><th>å‹•ä½œ</th><th>ç®¡ç†å“¡</th><th>å‚™è¨»</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <aside class="side">
      <div class="card">
        <div class="title">âš™ï¸ äººå“¡åå–®èˆ‡ç®¡ç†å“¡</div>
        <div class="grid-2 mt-2">
          <div>
            <div class="muted">æ¸…æ½”äººå“¡</div>
            <div id="staffList" class="list mt-1"></div>
            <div class="mt-2" style="display:flex;gap:8px;">
              <input id="addSid" placeholder="ä»£è™Ÿ C001" style="width:110px">
              <input id="addSname" placeholder="å§“å" style="width:140px">
              <button id="btnAddStaff" class="btn">æ–°å¢</button>
            </div>
          </div>
          <div>
            <div class="muted">ç®¡ç†å“¡</div>
            <div id="adminList" class="list mt-1"></div>
            <div class="mt-2" style="display:flex;gap:8px;">
              <input id="addAcode" placeholder="ä»£ç¢¼ A001" style="width:110px">
              <input id="addAname" placeholder="å§“å/èº«åˆ†" style="width:140px">
              <button id="btnAddAdmin" class="btn">æ–°å¢</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card mt-4">
        <div class="title">ğŸ“„ æœˆåº¦ç°½åˆ°ç°¿é è¦½ï¼ˆåˆ—å°ç”¨ï¼‰</div>
        <div id="books" class="mt-2"></div>
      </div>
    </aside>
  </div>
</div>

<script>
// ===== Local Storage Keys =====
const LS = { staff:"cleaner_staff_v1", admins:"cleaner_admins_v1", records:"cleaner_attendance_v1" };

// ===== Utilities =====
const $ = sel => document.querySelector(sel);
const todayISO = () => new Date().toISOString().slice(0,10);
const monthKey = d => d.slice(0,7);
const fmtTime = ts => new Date(ts).toLocaleTimeString();
const csvEsc = v => { if (v==null) return ""; const s=String(v); return (s.includes('"')||s.includes(",")||s.includes("\n"))? '"' + s.replaceAll('"','""') + '"': s; };
function saveFile(filename, text, mime="text/plain;charset=utf-8"){ const blob = new Blob([text], {type:mime}); const url = URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
function loadLS(key, fallback){ try{ const v = localStorage.getItem(key); return v? JSON.parse(v): fallback; }catch(e){ return fallback; } }
function saveLS(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

// ===== Data =====
let STAFF = loadLS(LS.staff, [
  {id:"C001", name:"ç‹å°ç¾"},
  {id:"C002", name:"æé˜¿èŠ±"},
  {id:"C003", name:"å¼µå¤§åŒ"},
  {id:"C004", name:"é™³é›€æƒ "},
  {id:"C005", name:"é™³æ¸…æ·‡"},
]);
let ADMINS = loadLS(LS.admins, [
  {code:"A001", name:"ç®¡ç†å“¡A001"},
]);
let RECS = loadLS(LS.records, []);

let LOGGED = null;
let CUR_STAFF = null;
let CUR_SHIFT = "AM";
let CUR_ACTION = "IN";

// ===== Elements =====
const monthPicker = document.getElementById("monthPicker");
const filterStaff = document.getElementById("filterStaff");
const btnExport = document.getElementById("btnExport");
const btnPrint = document.getElementById("btnPrint");

const adminStatus = document.getElementById("adminStatus");
const adminLoginBox = document.getElementById("adminLoginBox");
const adminAuthedBox = document.getElementById("adminAuthedBox");
const adminAuthedPill = document.getElementById("adminAuthedPill");
const adminCodeInput = document.getElementById("adminCodeInput");
const btnAdminLogin = document.getElementById("btnAdminLogin");
const btnAdminLogout = document.getElementById("btnAdminLogout");

const manualStaff = document.getElementById("manualStaff");
const btnUseManual = document.getElementById("btnUseManual");
const pickedStaff = document.getElementById("pickedStaff");
const btnAM = document.getElementById("btnAM");
const btnPM = document.getElementById("btnPM");
const btnOT = document.getElementById("btnOT");
const btnIN = document.getElementById("btnIN");
const btnOUT = document.getElementById("btnOUT");
const note = document.getElementById("note");
const btnSave = document.getElementById("btnSave");
const btnUndo = document.getElementById("btnUndo");

const tblMonthBody = document.querySelector("#tblMonth tbody");
const staffList = document.getElementById("staffList");
const adminList = document.getElementById("adminList");
const addSid = document.getElementById("addSid");
const addSname = document.getElementById("addSname");
const btnAddStaff = document.getElementById("btnAddStaff");
const addAcode = document.getElementById("addAcode");
const addAname = document.getElementById("addAname");
const btnAddAdmin = document.getElementById("btnAddAdmin");
const books = document.getElementById("books");

// ===== Init =====
monthPicker.value = monthKey(todayISO());
renderStaffFilter();
renderMonth();
renderLists();
renderBooks();
updatePicked();

// ===== URL Query Support =====
function getQuery(){ const q={}; try{ const sp=new URLSearchParams(location.search); for (const [k,v] of sp.entries()){ q[k.toLowerCase()]=v; } }catch(e){} return q; }
const Q = getQuery();
if (Q.staff){ const id = (Q.staff.includes(":")? Q.staff.split(":")[1]: Q.staff).trim(); const st = STAFF.find(s=>s.id===id); if (st){ CUR_STAFF = st; updatePicked(); } }
if (Q.admin){ const adm = ADMINS.find(a=>a.code===(Q.admin||"").trim()); if (adm){ LOGGED = adm; adminStatus.textContent="å·²ç™»å…¥"; adminLoginBox.style.display="none"; adminAuthedBox.style.display="block"; adminAuthedPill.textContent = `${adm.name}ï¼ˆ${adm.code}ï¼‰`; } }
if (Q.shift){ setShift(Q.shift.toUpperCase()); }
if (Q.action){ setAction(Q.action.toUpperCase()); }
window.addEventListener("load", ()=>{
  if (Q.autosave==="1" && LOGGED && CUR_STAFF){
    btnSave.click();
    try{ const url=new URL(location.href); url.search=""; history.replaceState({}, "", url.toString()); }catch(e){}
  }
});

// ===== Admin Login =====
btnAdminLogin.addEventListener("click", ()=>{
  const code = adminCodeInput.value.trim();
  const adm = ADMINS.find(a=>a.code===code);
  if (!adm){ alert("ç®¡ç†å“¡ä»£ç¢¼éŒ¯èª¤"); return; }
  LOGGED = adm;
  adminStatus.textContent = "å·²ç™»å…¥";
  adminLoginBox.style.display="none";
  adminAuthedBox.style.display="block";
  adminAuthedPill.textContent = `${adm.name}ï¼ˆ${adm.code}ï¼‰`;
  adminCodeInput.value = "";
});
btnAdminLogout.addEventListener("click", ()=>{
  LOGGED = null;
  adminStatus.textContent = "æœªç™»å…¥";
  adminLoginBox.style.display="block";
  adminAuthedBox.style.display="none";
});

// ===== Shift & Action =====
function setShift(s){ CUR_SHIFT=s; [btnAM,btnPM,btnOT].forEach(b=>b.classList.remove("btn-primary")); ({AM:btnAM,PM:btnPM,OT:btnOT})[s].classList.add("btn-primary"); }
function setAction(a){ CUR_ACTION=a; [btnIN,btnOUT].forEach(b=>b.classList.remove("btn-primary")); ({IN:btnIN,OUT:btnOUT})[a].classList.add("btn-primary"); }
btnAM.onclick=()=>setShift("AM"); btnPM.onclick=()=>setShift("PM"); btnOT.onclick=()=>setShift("OT");
btnIN.onclick=()=>setAction("IN"); btnOUT.onclick=()=>setAction("OUT");
setShift("AM"); setAction("IN");

// ===== Manual pick =====
btnUseManual.addEventListener("click", ()=>{
  const t = manualStaff.value.trim();
  if (!t){ alert("è«‹è¼¸å…¥å“¡å·¥ä»£è™Ÿ"); return; }
  const id = (t.includes(":")? t.split(":")[1]: t).trim();
  const st = STAFF.find(s=>s.id===id);
  if (st){ CUR_STAFF = st; updatePicked(); } else { alert(`ç„¡æ­¤å“¡å·¥ä»£è™Ÿï¼š${id}`); }
});
manualStaff.addEventListener("keydown", e=>{ if (e.key==="Enter") btnUseManual.click(); });

function updatePicked(){ pickedStaff.textContent = CUR_STAFF ? `${CUR_STAFF.name}ï¼ˆ${CUR_STAFF.id}ï¼‰` : "â€”"; }

// ===== Save / Undo =====
btnSave.addEventListener("click", ()=>{
  if (!LOGGED){ alert("è«‹å…ˆä»¥ç®¡ç†å“¡ä»£ç¢¼ç™»å…¥"); return; }
  if (!CUR_STAFF){ alert("å°šæœªæŒ‡å®šæ¸…æ½”äººå“¡ï¼ˆç”¨ QR App é–‹å•Ÿæˆ–æ‰‹å‹•è¼¸å…¥ä»£è™Ÿï¼‰"); return; }
  const rec = { ts:Date.now(), dateISO:todayISO(), staffId:CUR_STAFF.id, staffName:CUR_STAFF.name, adminCode:LOGGED.code, adminName:LOGGED.name, shift:CUR_SHIFT, action:CUR_ACTION, note:note.value.trim()||"" };
  RECS.unshift(rec); saveLS(LS.records, RECS); note.value=""; renderMonth(); renderBooks();
});
btnUndo.addEventListener("click", ()=>{
  if (!LOGGED){ alert("è«‹å…ˆç™»å…¥"); return; }
  if (!RECS.length) return;
  const r = RECS[0];
  if (confirm(`åˆªé™¤æœ€è¿‘ä¸€ç­†ï¼š${r.staffName} ${r.shift} ${r.action} @ ${new Date(r.ts).toLocaleString()} ?`)){
    RECS.shift(); saveLS(LS.records, RECS); renderMonth(); renderBooks();
  }
});

// ===== Staff/Admin mgmt =====
function renderLists(){
  staffList.innerHTML = "";
  STAFF.forEach(s=>{
    const div = document.createElement("div"); div.className="item";
    div.innerHTML = `<span>${s.name}ï¼ˆ${s.id}ï¼‰</span>`;
    const b = document.createElement("button"); b.className="btn btn-danger"; b.textContent="åˆª";
    b.onclick = ()=>{ if (confirm(`åˆªé™¤å“¡å·¥ ${s.id} ?ï¼ˆå‡ºå‹¤ç´€éŒ„ä¸æœƒè¢«åˆªé™¤ï¼‰`)){ STAFF = STAFF.filter(x=>x.id!==s.id); saveLS(LS.staff, STAFF); renderLists(); renderStaffFilter(); } };
    div.appendChild(b); staffList.appendChild(div);
  });
  adminList.innerHTML = "";
  ADMINS.forEach(a=>{
    const div = document.createElement("div"); div.className="item";
    div.innerHTML = `<span>${a.name}ï¼ˆ${a.code}ï¼‰</span>`;
    const b = document.createElement("button"); b.className="btn btn-danger"; b.textContent="åˆª";
    b.onclick = ()=>{ if (confirm(`åˆªé™¤ç®¡ç†å“¡ ${a.code}?`)){ ADMINS = ADMINS.filter(x=>x.code!==a.code); saveLS(LS.admins, ADMINS); renderLists(); } };
    div.appendChild(b); adminList.appendChild(div);
  });
}
btnAddStaff.onclick = ()=>{
  const id = addSid.value.trim(); const name = addSname.value.trim();
  if (!id || !name) return;
  if (STAFF.some(s=>s.id===id)) { alert("æ­¤å“¡å·¥ä»£è™Ÿå·²å­˜åœ¨"); return; }
  STAFF.push({id,name}); saveLS(LS.staff, STAFF); addSid.value=""; addSname.value=""; renderLists(); renderStaffFilter();
};
btnAddAdmin.onclick = ()=>{
  const code = addAcode.value.trim(); const name = addAname.value.trim();
  if (!code || !name) return;
  if (ADMINS.some(a=>a.code===code)) { alert("æ­¤ç®¡ç†å“¡ä»£ç¢¼å·²å­˜åœ¨"); return; }
  ADMINS.push({code,name}); saveLS(LS.admins, ADMINS); addAcode.value=""; addAname.value=""; renderLists();
};

function renderStaffFilter(){
  const cur = filterStaff.value || "all";
  filterStaff.innerHTML = `<option value="all">å…¨éƒ¨äººå“¡</option>` + STAFF.map(s=>`<option value="${s.id}">${s.id} â€” ${s.name}</option>`).join("");
  filterStaff.value = cur;
}

// ===== Month view & export & books =====
function getMonthRecords(){ const m=monthPicker.value; return RECS.filter(r=>monthKey(r.dateISO)===m && (filterStaff.value==="all" || r.staffId===filterStaff.value)); }
function renderMonth(){
  const rs = getMonthRecords().slice().sort((a,b)=>a.ts-b.ts);
  tblMonthBody.innerHTML = rs.map(r=>{
    const shift = r.shift==="AM"?"ä¸Šåˆ":r.shift==="PM"?"ä¸‹åˆ":"åŠ ç­";
    const act = r.action==="IN"?"ç°½åˆ°":"ç°½é€€";
    return `<tr><td>${r.dateISO}</td><td>${fmtTime(r.ts)}</td><td>${r.staffName}ï¼ˆ${r.staffId}ï¼‰</td><td>${shift}</td><td>${act}</td><td>${r.adminName}ï¼ˆ${r.adminCode}ï¼‰</td><td>${r.note||""}</td></tr>`;
  }).join("") || `<tr><td colspan="7" style="text-align:center;color:#94a3b8;padding:24px">æœ¬æœˆå°šç„¡ç´€éŒ„</td></tr>`;
}
function renderBooks(){
  const m = monthPicker.value;
  const map = new Map();
  RECS.forEach(r=>{
    if (monthKey(r.dateISO)!==m) return;
    if (!map.has(r.staffId)) map.set(r.staffId, {staff:{id:r.staffId,name:r.staffName}, days:{}});
    const g = map.get(r.staffId);
    if (!g.days[r.dateISO]) g.days[r.dateISO] = { AM:{IN:null,OUT:null}, PM:{IN:null,OUT:null}, OT:{IN:null,OUT:null} };
    g.days[r.dateISO][r.shift][r.action] = r;
  });
  const list = Array.from(map.values()).sort((a,b)=>a.staff.id.localeCompare(b.staff.id));
  books.innerHTML = list.map(({staff,days})=>{
    const rows = Object.keys(days).sort().map(d=>{
      const v = days[d];
      const time = rec => rec? fmtTime(rec.ts): "";
      const adminN = rec => rec? rec.adminName: "";
      const adminName = adminN(v.AM.IN)||adminN(v.PM.IN)||adminN(v.OT.IN)||"";
      return `<tr><td>${d}</td><td>${time(v.AM.IN)}</td><td>${time(v.AM.OUT)}</td><td>${time(v.PM.IN)}</td><td>${time(v.PM.OUT)}</td><td>${time(v.OT.IN)}</td><td>${time(v.OT.OUT)}</td><td>${adminName}</td></tr>`;
    }).join("");
    return `<div class="card page-break" style="margin-top:12px"><div style="font-weight:600">${staff.name}ï¼ˆ${staff.id}ï¼‰â€” ${m}</div><div class="table-wrap mt-1"><table><thead><tr style="background:#f1f5f9"><th>æ—¥æœŸ</th><th>ä¸ŠåˆIN</th><th>ä¸ŠåˆOUT</th><th>ä¸‹åˆIN</th><th>ä¸‹åˆOUT</th><th>åŠ ç­IN</th><th>åŠ ç­OUT</th><th>ç®¡ç†å“¡ç°½å</th></tr></thead><tbody>${rows}</tbody></table></div></div>`;
  }).join("") || `<div class="muted">æœ¬æœˆå°šç„¡ç°½åˆ°ç°¿å…§å®¹</div>`;
}

filterStaff.addEventListener("change", renderMonth);
monthPicker.addEventListener("change", ()=>{ renderMonth(); renderBooks(); });

btnExport.addEventListener("click", ()=>{
  const m = monthPicker.value;
  const rs = getMonthRecords().slice().sort((a,b)=>a.ts-b.ts);
  const rows = [["æ—¥æœŸ","æ™‚é–“","å“¡å·¥ä»£è™Ÿ","å“¡å·¥å§“å","ç­åˆ¥","å‹•ä½œ","ç®¡ç†å“¡ä»£ç¢¼","ç®¡ç†å“¡å§“å","å‚™è¨»"], ...rs.map(r=>[r.dateISO, new Date(r.ts).toLocaleTimeString(), r.staffId, r.staffName, r.shift, r.action, r.adminCode, r.adminName, r.note||""])];
  const csv = rows.map(r=>r.map(csvEsc).join(",")).join("\n");
  saveFile(`${m}_cleaner_attendance.csv`, csv, "text/csv;charset=utf-8");
});
btnPrint.addEventListener("click", ()=>window.print());
</script>
</body>
</html>
